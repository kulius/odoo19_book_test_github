# library-borrowing-management Specification

## Purpose
TBD - created by archiving change add-library-borrowing-management. Update Purpose after archive.
## Requirements
### Requirement: 借閱記錄管理
系統 SHALL 提供完整的借閱記錄管理功能，包括建立、查詢、更新借閱記錄。

#### Scenario: 建立借閱記錄
- **GIVEN** 使用者是圖書管理員
- **AND** 系統中存在一本可借閱的書籍（available_quantity > 0）
- **WHEN** 使用者建立新的借閱記錄
- **AND** 選擇借閱者和書籍
- **THEN** 系統成功建立借閱記錄
- **AND** 自動設定借閱日期為今天
- **AND** 自動計算到期日（借閱日期 + 14 天）
- **AND** 狀態設為「草稿」

#### Scenario: 借閱記錄必填欄位驗證
- **GIVEN** 使用者嘗試建立借閱記錄
- **WHEN** 必填欄位（借閱者、書籍）未填寫
- **THEN** 系統拒絕儲存
- **AND** 標示未填寫的欄位
- **AND** 顯示錯誤訊息

#### Scenario: 查詢借閱記錄
- **GIVEN** 系統中存在多筆借閱記錄
- **WHEN** 使用者查詢借閱記錄
- **THEN** 系統顯示所有借閱記錄
- **AND** 可依借閱者、書籍、狀態過濾
- **AND** 可依日期排序

### Requirement: 借閱操作
系統 SHALL 支援借閱操作，自動扣減書籍可借閱數量，並設定借閱狀態。

#### Scenario: 執行借閱操作成功
- **GIVEN** 使用者是圖書管理員
- **AND** 存在一筆草稿狀態的借閱記錄
- **AND** 該書籍的可借閱數量大於 0
- **WHEN** 使用者點擊「借閱」按鈕
- **THEN** 系統將借閱記錄狀態改為「借閱中」
- **AND** 書籍的可借閱數量減 1
- **AND** 在 Chatter 中記錄借閱訊息
- **AND** 顯示成功訊息

#### Scenario: 借閱操作失敗 - 庫存不足
- **GIVEN** 使用者是圖書管理員
- **AND** 存在一筆草稿狀態的借閱記錄
- **AND** 該書籍的可借閱數量為 0
- **WHEN** 使用者點擊「借閱」按鈕
- **THEN** 系統拒絕操作
- **AND** 顯示錯誤訊息「書籍庫存不足」
- **AND** 借閱記錄狀態保持「草稿」

#### Scenario: 借閱操作失敗 - 狀態不正確
- **GIVEN** 使用者是圖書管理員
- **AND** 存在一筆已借閱或已歸還的借閱記錄
- **WHEN** 使用者嘗試再次借閱
- **THEN** 系統拒絕操作
- **AND** 顯示錯誤訊息「只能借閱草稿狀態的記錄」

### Requirement: 歸還操作
系統 SHALL 支援歸還操作，自動增加書籍可借閱數量，並記錄歸還日期。

#### Scenario: 執行歸還操作成功
- **GIVEN** 使用者是圖書管理員
- **AND** 存在一筆借閱中狀態的借閱記錄
- **WHEN** 使用者點擊「歸還」按鈕
- **THEN** 系統將借閱記錄狀態改為「已歸還」
- **AND** 記錄歸還日期為今天
- **AND** 書籍的可借閱數量加 1
- **AND** 在 Chatter 中記錄歸還訊息
- **AND** 顯示成功訊息

#### Scenario: 歸還操作失敗 - 狀態不正確
- **GIVEN** 使用者是圖書管理員
- **AND** 存在一筆草稿或已歸還的借閱記錄
- **WHEN** 使用者嘗試歸還
- **THEN** 系統拒絕操作
- **AND** 顯示錯誤訊息「只能歸還借閱中的記錄」

#### Scenario: 逾期歸還記錄
- **GIVEN** 使用者是圖書管理員
- **AND** 存在一筆借閱中且已逾期的借閱記錄
- **WHEN** 使用者點擊「歸還」按鈕
- **THEN** 系統成功執行歸還
- **AND** 在 Chatter 中記錄逾期歸還訊息
- **AND** 顯示逾期天數

### Requirement: 續借操作
系統 SHALL 支援續借操作，延長到期日，並限制續借次數。

#### Scenario: 執行續借操作成功
- **GIVEN** 使用者是圖書管理員
- **AND** 存在一筆借閱中狀態的借閱記錄
- **AND** 該記錄的續借次數小於最大續借次數（2 次）
- **WHEN** 使用者點擊「續借」按鈕
- **THEN** 系統延長到期日 14 天
- **AND** 續借次數加 1
- **AND** 在 Chatter 中記錄續借訊息
- **AND** 顯示新的到期日

#### Scenario: 續借操作失敗 - 超過續借次數
- **GIVEN** 使用者是圖書管理員
- **AND** 存在一筆借閱中狀態的借閱記錄
- **AND** 該記錄的續借次數已達最大續借次數（2 次）
- **WHEN** 使用者點擊「續借」按鈕
- **THEN** 系統拒絕操作
- **AND** 顯示錯誤訊息「已達最大續借次數」

#### Scenario: 續借操作失敗 - 狀態不正確
- **GIVEN** 使用者是圖書管理員
- **AND** 存在一筆草稿或已歸還的借閱記錄
- **WHEN** 使用者嘗試續借
- **THEN** 系統拒絕操作
- **AND** 顯示錯誤訊息「只能續借借閱中的記錄」

#### Scenario: 可否續借狀態顯示
- **GIVEN** 使用者查看借閱記錄
- **WHEN** 借閱記錄狀態為「借閱中」
- **AND** 續借次數小於最大續借次數
- **THEN** 顯示「可續借」標示
- **AND** 續借按鈕可用

### Requirement: 取消操作
系統 SHALL 支援取消借閱操作，恢復書籍庫存（如尚未歸還）。

#### Scenario: 取消草稿狀態的借閱
- **GIVEN** 使用者是圖書管理員
- **AND** 存在一筆草稿狀態的借閱記錄
- **WHEN** 使用者點擊「取消」按鈕
- **THEN** 系統將借閱記錄狀態改為「已取消」
- **AND** 書籍的可借閱數量不變（因為尚未借出）
- **AND** 在 Chatter 中記錄取消訊息

#### Scenario: 取消借閱中的借閱
- **GIVEN** 使用者是圖書管理員
- **AND** 存在一筆借閱中狀態的借閱記錄
- **WHEN** 使用者點擊「取消」按鈕
- **THEN** 系統將借閱記錄狀態改為「已取消」
- **AND** 書籍的可借閱數量加 1（恢復庫存）
- **AND** 在 Chatter 中記錄取消訊息

#### Scenario: 無法取消已歸還的借閱
- **GIVEN** 使用者是圖書管理員
- **AND** 存在一筆已歸還狀態的借閱記錄
- **WHEN** 使用者嘗試取消
- **THEN** 系統拒絕操作
- **AND** 顯示錯誤訊息「無法取消已歸還的借閱」

### Requirement: 逾期計算和提醒
系統 SHALL 自動計算逾期天數，並提供逾期記錄的過濾和提醒功能。

#### Scenario: 計算逾期天數 - 未歸還
- **GIVEN** 存在一筆借閱中狀態的借閱記錄
- **AND** 到期日為 3 天前
- **WHEN** 系統計算逾期天數
- **THEN** 逾期天數為 3
- **AND** 是否逾期標記為 True
- **AND** 在列表視圖中以紅色標示

#### Scenario: 計算逾期天數 - 已歸還
- **GIVEN** 存在一筆已歸還狀態的借閱記錄
- **AND** 歸還日期晚於到期日 2 天
- **WHEN** 系統計算逾期天數
- **THEN** 逾期天數為 2
- **AND** 是否逾期標記為 True
- **AND** 記錄顯示逾期歸還

#### Scenario: 未逾期的借閱
- **GIVEN** 存在一筆借閱中狀態的借閱記錄
- **AND** 到期日為未來日期
- **WHEN** 系統計算逾期天數
- **THEN** 逾期天數為 0
- **AND** 是否逾期標記為 False
- **AND** 在列表視圖中正常顯示

#### Scenario: 過濾逾期借閱記錄
- **GIVEN** 系統中存在多筆借閱記錄，包括逾期和未逾期
- **WHEN** 使用者選擇「逾期」過濾器
- **THEN** 系統只顯示逾期且尚未歸還的借閱記錄
- **AND** 依逾期天數排序（逾期最久的在前）

### Requirement: 借閱歷史追蹤
系統 SHALL 在書籍詳細資訊中顯示完整的借閱歷史記錄。

#### Scenario: 查看書籍借閱歷史
- **GIVEN** 使用者開啟一本書籍的表單視圖
- **AND** 該書籍有多筆借閱記錄
- **WHEN** 使用者切換到「借閱歷史」分頁
- **THEN** 系統顯示該書籍的所有借閱記錄
- **AND** 包括借閱中和已歸還的記錄
- **AND** 依借閱日期排序（最新的在前）

#### Scenario: 統計總借閱次數
- **GIVEN** 使用者查看書籍列表或表單
- **WHEN** 系統計算總借閱次數
- **THEN** 顯示該書籍被借閱的總次數
- **AND** 包括已歸還的借閱記錄
- **AND** 不包括草稿和已取消的記錄

#### Scenario: 顯示當前借閱資訊
- **GIVEN** 使用者查看書籍表單
- **AND** 該書籍目前被借出（有借閱中的記錄）
- **WHEN** 系統顯示當前借閱資訊
- **THEN** 顯示當前借閱者姓名
- **AND** 顯示借閱日期和到期日
- **AND** 如已逾期，顯示逾期天數

### Requirement: 快速借閱功能
系統 SHALL 在書籍表單中提供快速借閱按鈕，簡化借閱流程。

#### Scenario: 使用快速借閱按鈕
- **GIVEN** 使用者是圖書管理員
- **AND** 開啟一本有庫存的書籍表單
- **WHEN** 使用者點擊「快速借閱」按鈕
- **THEN** 系統開啟新的借閱表單
- **AND** 書籍欄位自動填入當前書籍
- **AND** 借閱日期自動設為今天
- **AND** 使用者只需選擇借閱者

#### Scenario: 無庫存時隱藏快速借閱按鈕
- **GIVEN** 使用者開啟一本無庫存的書籍表單
- **WHEN** 系統載入表單
- **THEN** 快速借閱按鈕不顯示
- **AND** 顯示「無庫存」提示

### Requirement: 借閱權限控制
系統 SHALL 實作基於角色的權限控制，區分一般使用者和圖書管理員的借閱操作權限。

#### Scenario: 管理員完整借閱權限
- **GIVEN** 使用者屬於「Library Manager」群組
- **WHEN** 使用者存取借閱管理功能
- **THEN** 可以建立、查看、修改、刪除所有借閱記錄
- **AND** 可以執行借閱、歸還、續借、取消操作
- **AND** 可以查看所有使用者的借閱記錄

#### Scenario: 一般使用者借閱權限
- **GIVEN** 使用者屬於「Library User」群組
- **WHEN** 使用者存取借閱管理功能
- **THEN** 只能查看自己的借閱記錄
- **AND** 無法建立、修改或刪除借閱記錄
- **AND** 無法查看其他使用者的借閱記錄
- **AND** 嘗試存取其他記錄時顯示權限不足訊息

#### Scenario: 未授權使用者無法存取借閱功能
- **GIVEN** 使用者不屬於任何圖書館相關群組
- **WHEN** 使用者嘗試存取借閱管理功能
- **THEN** 系統拒絕存取
- **AND** 選單中不顯示借閱管理相關項目

### Requirement: 借閱視圖顯示
系統 SHALL 提供多種視圖模式（列表、表單、看板）來顯示借閱資訊。

#### Scenario: 列表視圖顯示
- **GIVEN** 使用者查看借閱記錄列表
- **WHEN** 系統載入列表視圖
- **THEN** 顯示關鍵欄位：借閱者、書籍、借閱日期、到期日、狀態
- **AND** 逾期且未歸還的記錄以紅色標示
- **AND** 已歸還的記錄以綠色標示
- **AND** 可依狀態、日期排序

#### Scenario: 表單視圖顯示
- **GIVEN** 使用者開啟一筆借閱記錄的詳細資訊
- **WHEN** 系統載入表單視圖
- **THEN** Header 顯示狀態列和動作按鈕
- **AND** Sheet 顯示借閱資訊（借閱者、書籍、日期）
- **AND** 顯示續借次數和逾期資訊
- **AND** 底部顯示 Chatter 訊息追蹤區域

#### Scenario: 看板視圖顯示
- **GIVEN** 使用者切換到看板視圖
- **WHEN** 系統載入看板視圖
- **THEN** 以卡片形式顯示借閱記錄
- **AND** 預設依狀態分組（草稿、借閱中、已歸還、已取消）
- **AND** 每張卡片顯示：借閱者、書籍、到期日
- **AND** 逾期的卡片以紅色邊框標示

#### Scenario: 搜尋視圖功能
- **GIVEN** 使用者在任何視圖模式
- **WHEN** 使用者使用搜尋功能
- **THEN** 提供搜尋框（支援借閱者、書籍）
- **AND** 提供過濾器（借閱中、已歸還、逾期、可續借）
- **AND** 提供分組選項（依借閱者、依書籍、依狀態）

### Requirement: 訊息追蹤
系統 SHALL 追蹤借閱記錄的所有操作，並提供訊息追蹤功能。

#### Scenario: 記錄借閱操作
- **GIVEN** 使用者執行借閱操作
- **WHEN** 借閱成功
- **THEN** 系統在 Chatter 中記錄借閱訊息
- **AND** 顯示借閱者、書籍、借閱日期、到期日
- **AND** 顯示操作者的使用者名稱和時間

#### Scenario: 記錄歸還操作
- **GIVEN** 使用者執行歸還操作
- **WHEN** 歸還成功
- **THEN** 系統在 Chatter 中記錄歸還訊息
- **AND** 顯示歸還日期
- **AND** 如有逾期，顯示逾期天數

#### Scenario: 記錄續借操作
- **GIVEN** 使用者執行續借操作
- **WHEN** 續借成功
- **THEN** 系統在 Chatter 中記錄續借訊息
- **AND** 顯示原到期日和新到期日
- **AND** 顯示續借次數

#### Scenario: 新增活動提醒
- **GIVEN** 使用者開啟借閱記錄的表單視圖
- **WHEN** 使用者建立活動提醒（如「提醒歸還」）
- **THEN** 系統建立活動記錄
- **AND** 在到期時通知相關使用者

