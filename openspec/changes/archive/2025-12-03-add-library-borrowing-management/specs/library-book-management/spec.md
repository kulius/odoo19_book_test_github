# library-book-management Specification Deltas

## MODIFIED Requirements

### Requirement: 圖書庫存追蹤
系統 SHALL 追蹤每本書籍的總數量和可借閱數量，並根據借閱狀態自動更新可借閱數量。

#### Scenario: 設定書籍庫存
- **GIVEN** 使用者是圖書管理員
- **WHEN** 使用者新增或編輯書籍
- **AND** 設定總數量為 5
- **AND** 設定可借閱數量為 5
- **THEN** 系統記錄這些數量
- **AND** 書籍狀態顯示為「可借閱」

#### Scenario: 庫存數量驗證
- **GIVEN** 使用者是圖書管理員
- **WHEN** 使用者嘗試設定可借閱數量
- **AND** 可借閱數量大於總數量
- **THEN** 系統拒絕儲存
- **AND** 顯示錯誤訊息「可借閱數量不能大於總數量」

#### Scenario: 庫存數量非負驗證
- **GIVEN** 使用者是圖書管理員
- **WHEN** 使用者嘗試設定數量
- **AND** 數量為負數
- **THEN** 系統拒絕儲存
- **AND** 顯示錯誤訊息「數量必須為非負整數」

#### Scenario: 無庫存書籍顯示
- **GIVEN** 系統中存在一本書籍
- **AND** 該書籍的可借閱數量為 0
- **WHEN** 使用者查看書籍列表
- **THEN** 該書籍以特殊顏色標示（紅色）
- **AND** 狀態顯示為「無庫存」

#### Scenario: 有庫存書籍顯示
- **GIVEN** 系統中存在一本書籍
- **AND** 該書籍的可借閱數量大於 0
- **WHEN** 使用者查看書籍列表
- **THEN** 該書籍以正常顏色顯示（綠色）
- **AND** 狀態顯示為「可借閱」

#### Scenario: 借閱時自動扣減庫存
- **GIVEN** 系統中存在一本書籍，可借閱數量為 5
- **WHEN** 使用者執行借閱操作
- **THEN** 該書籍的可借閱數量自動減 1，變為 4
- **AND** 總數量保持不變
- **AND** 庫存變更記錄在訊息追蹤中

#### Scenario: 歸還時自動增加庫存
- **GIVEN** 系統中存在一本書籍，可借閱數量為 3
- **AND** 該書籍有一筆借閱中的記錄
- **WHEN** 使用者執行歸還操作
- **THEN** 該書籍的可借閱數量自動加 1，變為 4
- **AND** 總數量保持不變
- **AND** 庫存變更記錄在訊息追蹤中

#### Scenario: 取消借閱時恢復庫存
- **GIVEN** 系統中存在一本書籍，可借閱數量為 3
- **AND** 該書籍有一筆借閱中的記錄
- **WHEN** 使用者取消該借閱記錄
- **THEN** 該書籍的可借閱數量自動加 1，變為 4
- **AND** 總數量保持不變

## ADDED Requirements

### Requirement: 刪除書籍檢查
系統 SHALL 在刪除書籍前檢查是否有未歸還的借閱記錄。

#### Scenario: 刪除無借閱記錄的書籍
- **GIVEN** 使用者是圖書管理員
- **AND** 系統中存在一本書籍
- **AND** 該書籍沒有任何借閱記錄
- **WHEN** 使用者刪除該書籍
- **THEN** 系統成功刪除書籍記錄
- **AND** 書籍從列表中消失

#### Scenario: 刪除有已歸還借閱記錄的書籍
- **GIVEN** 使用者是圖書管理員
- **AND** 系統中存在一本書籍
- **AND** 該書籍有借閱記錄，但都已歸還
- **WHEN** 使用者刪除該書籍
- **THEN** 系統成功刪除書籍記錄
- **AND** 相關的借閱記錄保留（用於歷史追蹤）

#### Scenario: 無法刪除有未歸還借閱的書籍
- **GIVEN** 使用者是圖書管理員
- **AND** 系統中存在一本書籍
- **AND** 該書籍有借閱中（未歸還）的借閱記錄
- **WHEN** 使用者嘗試刪除該書籍
- **THEN** 系統拒絕刪除操作
- **AND** 顯示錯誤訊息「無法刪除有未歸還借閱的書籍」
- **AND** 提示使用者先處理未歸還的借閱記錄

### Requirement: 借閱統計資訊
系統 SHALL 在書籍資訊中顯示借閱統計資訊，包括總借閱次數和當前借閱狀態。

#### Scenario: 顯示總借閱次數
- **GIVEN** 使用者查看書籍列表或表單
- **AND** 該書籍有多筆借閱記錄（包括已歸還）
- **WHEN** 系統計算總借閱次數
- **THEN** 顯示該書籍被借閱的總次數
- **AND** 只計算狀態為「借閱中」或「已歸還」的記錄
- **AND** 不計算「草稿」或「已取消」的記錄

#### Scenario: 顯示當前借閱狀態
- **GIVEN** 使用者查看書籍表單
- **AND** 該書籍目前被借出（有借閱中的記錄）
- **WHEN** 系統顯示當前借閱資訊
- **THEN** 顯示「已借出」標記
- **AND** 顯示當前借閱者姓名
- **AND** 顯示預計歸還日期（到期日）
- **AND** 如已逾期，以紅色標示並顯示逾期天數

#### Scenario: 顯示可借閱狀態
- **GIVEN** 使用者查看書籍表單
- **AND** 該書籍目前未被借出（無借閱中的記錄）
- **AND** 可借閱數量大於 0
- **WHEN** 系統顯示借閱狀態
- **THEN** 顯示「可借閱」標記
- **AND** 顯示可借閱數量

#### Scenario: 統計按鈕顯示借閱次數
- **GIVEN** 使用者查看書籍表單
- **WHEN** 系統載入表單
- **THEN** 在 button_box 顯示統計按鈕
- **AND** 按鈕顯示總借閱次數
- **AND** 點擊按鈕可查看該書籍的所有借閱記錄

### Requirement: 快速借閱功能
系統 SHALL 在書籍表單中提供快速借閱按鈕，簡化借閱流程。

#### Scenario: 顯示快速借閱按鈕
- **GIVEN** 使用者是圖書管理員
- **AND** 開啟一本書籍的表單視圖
- **AND** 該書籍的可借閱數量大於 0
- **WHEN** 系統載入表單
- **THEN** 在 header 或 button_box 顯示「快速借閱」按鈕
- **AND** 按鈕為可用狀態

#### Scenario: 隱藏快速借閱按鈕 - 無庫存
- **GIVEN** 使用者開啟一本書籍的表單視圖
- **AND** 該書籍的可借閱數量為 0
- **WHEN** 系統載入表單
- **THEN** 快速借閱按鈕不顯示或為停用狀態
- **AND** 顯示「無庫存」提示

#### Scenario: 使用快速借閱按鈕
- **GIVEN** 使用者是圖書管理員
- **AND** 點擊書籍表單中的「快速借閱」按鈕
- **WHEN** 系統處理請求
- **THEN** 開啟新的借閱記錄表單
- **AND** 書籍欄位自動填入當前書籍
- **AND** 借閱日期自動設為今天
- **AND** 到期日自動計算
- **AND** 使用者只需選擇借閱者並確認

### Requirement: 借閱歷史顯示
系統 SHALL 在書籍表單中顯示完整的借閱歷史記錄。

#### Scenario: 查看借閱歷史分頁
- **GIVEN** 使用者開啟一本書籍的表單視圖
- **WHEN** 使用者切換到「借閱歷史」分頁（Notebook page）
- **THEN** 系統顯示該書籍的所有借閱記錄
- **AND** 使用內嵌列表視圖（One2many field）
- **AND** 顯示借閱者、借閱日期、到期日、歸還日期、狀態
- **AND** 依借閱日期排序（最新的在前）

#### Scenario: 空借閱歷史顯示
- **GIVEN** 使用者開啟一本從未被借閱的書籍表單
- **WHEN** 使用者切換到「借閱歷史」分頁
- **THEN** 顯示空列表
- **AND** 顯示提示訊息「此書籍尚未被借閱」

#### Scenario: 從借閱歷史開啟借閱記錄
- **GIVEN** 使用者在書籍表單的「借閱歷史」分頁
- **AND** 列表中有多筆借閱記錄
- **WHEN** 使用者點擊某筆借閱記錄
- **THEN** 系統開啟該借閱記錄的表單視圖
- **AND** 可查看完整的借閱詳情

