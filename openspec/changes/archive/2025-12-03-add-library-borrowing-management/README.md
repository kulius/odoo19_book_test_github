# 圖書館借閱管理功能提案

## 概述
為圖書館管理系統添加完整的借閱管理功能，包括借閱、歸還、續借和逾期管理。

## 狀態
📋 **提案階段** - 等待審核和批准

## 快速連結
- [提案文件](./proposal.md) - 變更的原因、內容和影響
- [設計文件](./design.md) - 技術設計決策和架構
- [任務清單](./tasks.md) - 實作步驟和驗收標準
- [規格增量](./specs/) - 新增和修改的需求規格

## 核心功能

### 新增功能
1. **借閱記錄管理**
   - 建立、查詢、更新借閱記錄
   - 支援草稿、借閱中、已歸還、已取消四種狀態

2. **借閱操作**
   - 借閱：自動扣減書籍庫存
   - 歸還：自動增加書籍庫存
   - 續借：延長到期日（最多 2 次）
   - 取消：恢復庫存（如尚未歸還）

3. **逾期管理**
   - 自動計算逾期天數
   - 逾期記錄特殊標示
   - 提供逾期過濾器

4. **借閱歷史**
   - 在書籍表單中顯示完整借閱歷史
   - 統計總借閱次數
   - 顯示當前借閱狀態

5. **快速借閱**
   - 書籍表單中的快速借閱按鈕
   - 簡化借閱流程

### 修改現有功能
1. **書籍庫存管理**
   - 借閱時自動扣減 `available_quantity`
   - 歸還時自動增加 `available_quantity`
   - 刪除書籍前檢查未歸還借閱

2. **書籍資訊顯示**
   - 添加借閱統計資訊
   - 添加當前借閱狀態
   - 添加借閱歷史分頁

## 技術架構

### 新增模型
- `library.borrowing` - 借閱記錄模型
  - 關聯 `res.partner`（借閱者）和 `library.book`（書籍）
  - 狀態管理：draft → borrowed → returned
  - 自動計算到期日和逾期天數

### 擴展模型
- `library.book` - 書籍模型
  - 添加 `borrowing_ids` (One2many)
  - 添加 `current_borrowing_id` (Many2one)
  - 添加 `borrowed_count` (computed)

### 視圖
- 借閱記錄：列表、表單、看板、搜尋視圖
- 書籍表單：添加借閱歷史分頁、統計按鈕、快速借閱按鈕

### 權限
- Library User：只能查看自己的借閱記錄
- Library Manager：可管理所有借閱記錄

## 業務規則

### 借閱規則
- 借閱前檢查庫存（`available_quantity > 0`）
- 預設借閱期限：14 天
- 自動計算到期日

### 續借規則
- 最大續借次數：2 次
- 續借延長天數：14 天
- 從原到期日延長

### 逾期規則
- 自動計算逾期天數
- 逾期記錄特殊標示（紅色）
- 可過濾逾期記錄

## 依賴關係
- 依賴：`library_management` 模組（第一階段）
- 使用：`res.partner` 作為借閱者
- 整合：`mail.thread` 訊息追蹤

## 實作順序
1. 建立 `library.borrowing` 模型
2. 實作借閱、歸還、續借業務邏輯
3. 擴展 `library.book` 模型
4. 實作視圖（列表、表單、看板）
5. 設定權限和記錄規則
6. 測試和驗證

## 驗收標準
- ✅ 可成功建立借閱記錄
- ✅ 借閱時自動扣減庫存
- ✅ 歸還時自動增加庫存
- ✅ 續借功能正常，受次數限制
- ✅ 逾期天數計算正確
- ✅ 權限控制正確（User vs Manager）
- ✅ 所有視圖正常顯示
- ✅ 通過 `openspec validate --strict`

## 未來擴展
- 逾期罰款計算
- 預約和排隊功能
- 借閱統計和報表
- 批量借閱/歸還
- 讀者會員管理

## 相關文件
- [第一階段：圖書資訊管理](../archive/2025-12-03-add-library-book-management/)
- [Odoo 19 開發規則](../../AGENTS.md)
- [專案規範](../../project.md)

